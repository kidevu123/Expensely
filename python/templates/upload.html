{% extends 'base.html' %}
{% block title %}Upload Â· Expensely{% endblock %}
{% block content %}
<div class="form">
	<h2>Upload Expense</h2>
	{% if request.GET.ok %}
		<p class="ok">Saved. ID = {{ request.GET.id }}</p>
	{% endif %}
	{% if errors %}
		<div class="error">{{ errors }}</div>
	{% endif %}
	<form id="upload-form" method="post" enctype="multipart/form-data">
		{% csrf_token %}
		<label>Type</label>
		{{ form.type }}
		<label>Show (required for Show type)</label>
		{{ form.show }}
		<label>Description</label>
		{{ form.description }}
		<label>Amount</label>
		{{ form.amount }}
		<label>Category</label>
		{{ form.category }}
		<label>Card last 4 <span class="hint">auto-filled from OCR if found</span></label>
		{{ form.last4 }}
		<label>Receipt (image/PDF)</label>
		{{ form.receipt }}
		<div class="preview" id="preview"></div>
		<button type="submit">Save expense</button>
	</form>
	<p style="margin-top:10px"><a href="/">Home</a></p>
</div>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script>
(function(){
	const input = document.querySelector('input[name="receipt"]');
	const last4El = document.querySelector('input[name="last4"]');
	const amountEl = document.querySelector('input[name="amount"]');
	const descEl = document.querySelector('input[name="description"]');
	const preview = document.getElementById('preview');
	function setPreview(file){
		preview.innerHTML = '';
		if(!file) return;
		const url = URL.createObjectURL(file);
		if(file.type.startsWith('image/')){
			const img = document.createElement('img');
			img.src = url; img.style.maxWidth='90%'; img.style.maxHeight='60vh'; img.style.objectFit='contain';
			preview.appendChild(img);
		}else if(file.type === 'application/pdf'){
			const iframe = document.createElement('iframe'); iframe.src = url; iframe.style.width='90%'; iframe.style.height='60vh';
			preview.appendChild(iframe);
		}else{ preview.textContent = 'Preview not available.'; }
	}
	function extractLast4(text){
		const patterns = [/(?:card|acct|account|visa|mc|master|amex|discover)[^\d]{0,10}(\d{4})/i,/\*{2,}\s*(\d{4})/i,/ending(?: in)?\s*(\d{4})/i,/(?:xxxx|x{4,})\s*(\d{4})/i,/(\d{4})\b(?![\d-])/];
		for(const re of patterns){ const m = text.match(re); if(m && m[1]) return m[1]; }
		return '';
	}
	function extractAmount(text){
		const re = /(\$?\s*\d{1,3}(?:,\d{3})*(?:\.\d{2})|\$?\s*\d+\.\d{2})/g; let match,last=''; while((match=re.exec(text))!==null){ last=match[1]; } return last.replace(/[^0-9.]/g,'');
	}
	async function runOCR(file){ if(!file||!file.type.startsWith('image/')) return; try{ const {data}=await Tesseract.recognize(file,'eng'); const text=(data&&data.text)||''; if(text){ if(!descEl.value){ const first=text.split(/\n+/).map(s=>s.trim()).filter(Boolean)[0]||''; descEl.value=first.slice(0,120);} if(!last4El.value){ const l4=extractLast4(text); if(l4) last4El.value=l4;} if(!amountEl.value){ const amt=extractAmount(text); if(amt) amountEl.value=amt; } } }catch(e){ console.warn('OCR failed',e); } }
	input.addEventListener('change', async (e)=>{ const f=e.target.files&&e.target.files[0]; setPreview(f); await runOCR(f); });
})();
</script>
{% endblock %}